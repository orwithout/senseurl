<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RxDB Test Template</title>
</head>
<body>
  <h1>RxDB Test Template</h1>
  <label>①</label> <button id="validateData">Validate Data</button> <button id="addData">Add Sample Data</button><br><br>
  <label>②</label> <input type="text" id="searchQuery" placeholder="Search text, example: Learn"> <button id="searchData">Search Content Field</button> <br><br>
  <label>③</label> <input type="text" id="fieldName" placeholder="Field Name"> <input type="text" id="fieldValue" placeholder="Field Value"> <button id="validateField">Validate Field</button> <br><br>
  <div id="results"></div>

  <script type="module">
    import { getDocIndexesRxdbCollection, validateData, validateField } from './doc_indexes.js';

    const baseDocsCollection = await getDocIndexesRxdbCollection();

    function displayResults(results) {
      console.log('Displaying results:', results);
      const resultDiv = document.getElementById('results');
      resultDiv.innerHTML = '';
      results.forEach(result => {
        const p = document.createElement('p');
        p.textContent = `ID: ${result.id}, Name: ${result.name}, Content: ${result.content}`;
        resultDiv.appendChild(p);
      });
    }

    // 添加示例数据
    window.sampleData = {
      id: Date.now().toString(),
      type: 'text/txt',
      size: 1024,
      name: 'Example Document',
      tags: ['cvalidate', 'test', 'sdfe'],
      // tags: 'cvalidate, test, sdfe',
      content: 'This is a sample document.',
      timestamp: new Date().toISOString()
    };


  // 验证数据
  document.getElementById('validateData').addEventListener('click', async () => {
    console.log('Validating data:', JSON.stringify(window.sampleData, null, 2));
    const validationResult = validateData(window.sampleData);
    if (!validationResult.valid) {
      console.error('Validation failed:', validationResult.errors);
      console.log('Validation Error! Check the console for more information.');
    } else {
      console.log('Validation successful! Ready to add data.');
    }
  });


    // 添加数据
  document.getElementById('addData').addEventListener('click', async () => {
    if (!window.sampleData) {
      console.error('No validated data available to add. Please validate data first.');
      return;
    }

    try {
      await baseDocsCollection.insert(window.sampleData);
      console.log('Data added successfully:', window.sampleData);
    } catch (error) {
      console.error('Error adding data:', error);
    }
  });

  // 搜索数据
  document.getElementById('searchData').addEventListener('click', async () => {
    const query = document.getElementById("searchQuery").value;
    const results = await baseDocsCollection.find({
      selector: { content: { $regex: query, $options: 'i' } }
    }).exec();
    displayResults(results);
  });

  // 单个字段验证
  document.getElementById('validateField').addEventListener('click', async () => {
    const fieldName = document.getElementById('fieldName').value;
    const fieldValue = document.getElementById('fieldValue').value;
    const validation = validateField(fieldName, fieldValue);
    if (!validation.valid) {
      console.log(fieldName,'validation failed:',`${validation.errors.map(err => err.message).join(", ")}`);
    } else {
      console.log('Field validation successful!');
    }
  });

  // 订阅数据变更
  baseDocsCollection.find().$.subscribe(results => {
    displayResults(results);
  });



</script>
</body>
</html>
