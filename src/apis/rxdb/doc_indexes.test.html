<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RxDB Test Template</title>
</head>
<body>
  <h1>RxDB Test Template</h1>
  <label>①</label> <button id="validateData">Validate Data</button> <button id="addData">Add Sample Data</button><br><br>
  <label>②</label> <input type="text" id="searchQuery" placeholder="Search text, example: Learn"> <button id="searchData">Search Content Field</button> <br><br>
  <label>③</label> <input type="text" id="fieldName" placeholder="Field Name"> <input type="text" id="fieldValue" placeholder="Field Value"> <button id="validateField">Validate Field</button> <br><br>
  <div id="results"></div>

  <script type="module">
    import { getRxdbCollectionInstance, validateData, validateField } from './doc_indexes.js';

    const baseDocsCollection = await getRxdbCollectionInstance();

    function displayResults(results) {
  console.log('Displaying results:', results);
  const resultDiv = document.getElementById('results');
  resultDiv.innerHTML = '';
  if (results.length === 0) {
    resultDiv.innerHTML = '<p>No results found.</p>';
    return;
  }
  results.forEach(result => {
    const p = document.createElement('p');
    p.textContent = `ID: ${result.doc.id}, Name: ${result.doc.name}, Content: ${result.doc.content}`;
    resultDiv.appendChild(p);
  });
}

  // Helper function to generate UUIDs
  function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
      var r = (Math.random() * 16) | 0,
        v = c == 'x' ? r : (r & 0x3) | 0x8;
      return v.toString(16);
    });
  }

  // 添加示例数据
  window.sampleData = {
    localId: uuidv4(),
    localPath: '/path/to/document',
    localCid: 'bafybeigdyrzt5sfp7udm7hu76uh7y26nf4dfuylqabf3oclgtqy55fbzdi',
    localVersions: [
      {
        cid: 'bafybeigdyrzt5sfp7udm7hu76uh7y26nf4dfuylqabf3oclgtqy55fbzdi',
        published: new Date().toISOString(),
      },
    ],
    doc: {
      id: uuidv4(),
      type: 'text/plain',
      cid: 'bafybeigdyrzt5sfp7udm7hu76uh7y26nf4dfuylqabf3oclgtqy55fbzdi',
      name: 'Example Document',
      actor: 'did:example:123456789abcdefghi',
      profile: 'https://example.com/profile',
      published: new Date().toISOString(),
      updated: new Date().toISOString(),
      accessed: new Date().toISOString(),
      tags: [{tag:'example'}, {tag:'test'}, {tag:'document'}],
      size: 1024,
      content: 'This is an example document for testing purposes.',
      accessKeys: [
        {
          id: uuidv4(),
          encryptedKey: 'EncryptedKey1',
        },
        {
          id: uuidv4(),
          encryptedKey: 'EncryptedKey2',
        },
      ],
    },
};




  // 验证数据
  document.getElementById('validateData').addEventListener('click', async () => {
    console.log('Validating data:', JSON.stringify(window.sampleData, null, 2));
    const validationResult = validateData(window.sampleData);
    if (!validationResult.valid) {
      console.error('Validation failed:', validationResult.errors);
      console.log('Validation Error! Check the console for more information.');
    } else {
      console.log('Validation successful! Ready to add data.');
    }
  });


    // 添加数据
  document.getElementById('addData').addEventListener('click', async () => {
    if (!window.sampleData) {
      console.error('No validated data available to add. Please validate data first.');
      return;
    }

    try {
      await baseDocsCollection.insert(window.sampleData);
      console.log('Data added successfully:', window.sampleData);
    } catch (error) {
      console.error('Error adding data:', error);
    }
  });

  // 搜索数据
  document.getElementById('searchData').addEventListener('click', async () => {
    const query = document.getElementById("searchQuery").value;
    if (!query) {console.error('No search query provided.');return;}
    const results = await baseDocsCollection.find({
      selector: { 'doc.content': { $regex: query, $options: 'i' } }
    }).limit(10).exec();
    displayResults(results);
  });

  // 单个字段验证
  document.getElementById('validateField').addEventListener('click', async () => {
  const fieldName = document.getElementById('fieldName').value;
  let fieldValue = document.getElementById('fieldValue').value;

  // 尝试解析 JSON 输入
  try {
    fieldValue = JSON.parse(fieldValue);
  } catch (e) {
    // 如果不是有效的 JSON，保持原始字符串值
  }

  const validation = validateField(fieldName, fieldValue);
  if (!validation.valid) {
    console.log(`${fieldName} validation failed:`, `${validation.errors.map(err => err.message).join(", ")}`);
  } else {
    console.log('Field validation successful!');
  }
});

  // 订阅数据变更
  baseDocsCollection.find().$.subscribe(results => {
    displayResults(results);
  });



</script>
</body>
</html>
